name: Update all images
on:
  workflow_dispatch:
  schedule:
    # Every day at 00:00 UTC
    - cron: "0 0 * * *"

jobs:
  build-images:
    strategy:
      matrix:
        image: ["rocky-ci"]
        release: [ "unstable" ]
    uses: ./.github/workflows/build-image.yml
    with:
      image_name: ${{ matrix.image }}
      tags: ${{ matrix.release }}
      publish: true
      branch: "${{ contains(matrix.release, 'unstable') && 'main' || format('f{0}', matrix.release) }}"
  cleanup-old-images:
    needs: [ "build-images" ]
    runs-on: ubuntu-latest
    steps:
    - uses: "actions/delete-package-versions@v5"
      with:
        package-name: rocky-ci
        package-type: container
        delete-only-untagged-versions: true
        min-versions-to-keep: 3
